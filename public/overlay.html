<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>노래 오버레이</title>
    <link rel="stylesheet" href="/common.css" />
    <link rel="stylesheet" href="/overlay.css" />
  </head>
  <body>
    <div class="overlay-root">
      <div class="overlay-card">
        <div class="overlay-section">
          <div class="overlay-title">현재곡</div>
          <div id="currentSong" class="overlay-current-text">-</div>
        </div>

        <div class="overlay-section overlay-queue-section">
          <div class="overlay-title">대기곡</div>
          <ul id="queueList" class="overlay-queue-list"></ul>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = ""; // 같은 도메인이면 빈 문자열

      function renderOverlay(data) {
        const currentEl = document.getElementById("currentSong");
        const queueEl = document.getElementById("queueList");

        if (data && data.current) {
          currentEl.textContent = `${data.current.artist} - ${data.current.title}`;
        } else {
          currentEl.textContent = "-";
        }

        queueEl.innerHTML = "";
        (data.queue || [])
          .slice(0, 3) // 최대 3곡 표시
          .forEach((item) => {
            const li = document.createElement("li");
            li.className = "overlay-queue-item";
            li.textContent = `${item.artist} - ${item.title}`;
            queueEl.appendChild(li);
          });
      }

      function connectOverlayStream() {
        try {
          const es = new EventSource(API_BASE + "/api/queue/stream");
          es.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              renderOverlay(data);
            } catch (e) {
              console.error("overlay SSE parse error", e);
            }
          };
          es.onerror = (err) => {
            console.error("overlay SSE error", err);
            es.close();
            setTimeout(connectOverlayStream, 5000);
          };
        } catch (e) {
          console.error("overlay SSE connect error", e);
        }
      }

      // 혹시 SSE가 막힌 환경 대비 1회 로딩
      async function loadOnce() {
        try {
          const res = await fetch(API_BASE + "/api/queue");
          if (!res.ok) return;
          const data = await res.json();
          renderOverlay(data);
        } catch (e) {
          console.error(e);
        }
      }

      loadOnce();
      connectOverlayStream();
    </script>
  </body>
</html>
